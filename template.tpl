___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "パッとブライダルGAクロスドメイン用タグ",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "パッとブライダル専用タグです。\nクロスドメイン設定で使用します。",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "GA4Group",
    "displayName": "GA4",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "ga4Id",
        "displayName": "Gから始まるID",
        "simpleValueType": true,
        "valueHint": "G-XXXXXXXX",
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "G.*"
            ],
            "errorMessage": "Gから始まるIDを入力してください。"
          }
        ],
        "alwaysInSummary": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');

// クロスドメイン用jsのURLを生成。挿入。
let connectUrl = 'https://crossdomain.official-wedding.net/js/cdm.js';
injectScript(connectUrl);

const createArgumentsQueue = require('createArgumentsQueue');
const createQueue = require('createQueue');

// グローバル変数createQueueにdataLayerを代入
const dlPush = createQueue('dataLayer');
// Gtag関数がなければ作成。dataLayerに値を入れる準備。
const gtag = createArgumentsQueue('gtag', 'dataLayer');

// 取得するフィールドのリストを作成
let fields = [];
const dataObj = {};
fields.push('client_id');
fields.push('session_id');
if(data.ga4Id) {
  const gtmga4Push= createQueue('gtmga4');
  gtmga4Push(data.ga4Id);
}

// 各フィールドを順番に取得し、最後にdataLayerにプッシュする。再帰処理。
const gtagGet = () => {
  gtag('get', data.ga4Id, fields[0], val => {
    dataObj[fields[0]] = val;
    fields.shift();
    if (fields.length) {
      gtagGet();
    } else {
      dlPush({
        event: 'gtagApiGet',
        gtagApiResult: dataObj
      });
      data.gtmOnSuccess();
    }
  });
};

// 再帰を初期化
if (data.ga4Id) { gtagGet(); }
else { data.gtmOnSuccess(); }


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.official-wedding.net/js/cdm.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtmga4"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 2024/5/16 16:15:25


